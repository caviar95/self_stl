å½“ä¸€ä¸ª**å®šæ—¶å™¨åˆ°æœŸæ—¶**ï¼Œå®ƒçš„å›è°ƒå‡½æ•°æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Ÿè¿™ä¸ªè¿‡ç¨‹æ¶‰åŠå¤šä¸ªç³»ç»Ÿ/çº¿ç¨‹æœºåˆ¶ã€‚ä¸‹é¢æˆ‘å°†ç”¨**è¯¦ç»†æµç¨‹å›¾**ä¸**æ—¶åºå›¾**æ¥è¯´æ˜å®šæ—¶å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»æ³¨å†Œåˆ°è§¦å‘å›è°ƒçš„å®Œæ•´è¿‡ç¨‹ã€‚

---

## ğŸ§­ ä¸€ã€å®šæ—¶å™¨å›è°ƒæ‰§è¡Œçš„æ€»ä½“æµç¨‹å›¾

### âœ… æµç¨‹ç¤ºæ„å›¾ï¼ˆä»¥ç”¨æˆ·ç©ºé—´å®šæ—¶å™¨ä¸ºä¾‹ï¼Œä¾‹å¦‚åŸºäº `std::thread` æˆ–äº‹ä»¶é©±åŠ¨åº“ï¼‰

```mermaid
flowchart TD
    A[åº”ç”¨çº¿ç¨‹æ³¨å†Œå®šæ—¶å™¨<br>SetTimer(callback, interval)] --> B[å®šæ—¶å™¨ç®¡ç†å™¨è®°å½•ä»»åŠ¡]
    B --> C[åå°å®šæ—¶å™¨çº¿ç¨‹/äº‹ä»¶å¾ªç¯]
    C --> D{å½“å‰æ—¶é—´ >= åˆ°æœŸæ—¶é—´?}
    D -- å¦ --> C
    D -- æ˜¯ --> E[è§¦å‘å›è°ƒ callback()]
    E --> F[æ‰§è¡Œä¸šåŠ¡é€»è¾‘ / é€šçŸ¥åŸçº¿ç¨‹ï¼ˆå¯é€‰ï¼‰]
```

---

## ğŸ•°ï¸ äºŒã€æ—¶åºå›¾ï¼ˆåŸºäºå¤šçº¿ç¨‹æ¨¡å‹ï¼‰

å‡è®¾åº”ç”¨çº¿ç¨‹æ³¨å†Œå®šæ—¶å™¨ï¼Œå®šæ—¶å™¨çº¿ç¨‹å‘¨æœŸæ€§æ£€æŸ¥æ˜¯å¦è¶…æ—¶ã€‚

```mermaid
sequenceDiagram
    participant AppThread as åº”ç”¨çº¿ç¨‹
    participant TimerMgr as å®šæ—¶å™¨ç®¡ç†å™¨
    participant TimerThread as å®šæ—¶å™¨çº¿ç¨‹
    participant Callback as å›è°ƒå‡½æ•°æ‰§è¡Œä½“

    AppThread->>TimerMgr: æ³¨å†Œå®šæ—¶å™¨(callback, interval)
    TimerMgr->>TimerThread: æ·»åŠ ä»»åŠ¡

    loop æ¯éš”Næ¯«ç§’è½®è¯¢
        TimerThread->>TimerMgr: æ£€æŸ¥å½“å‰æ—¶é—´æ˜¯å¦åˆ°æœŸ
        alt åˆ°æœŸ
            TimerThread->>Callback: æ‰§è¡Œ callback()
            Callback-->>TimerThread: å¤„ç†å®Œæˆ
        else æœªåˆ°æœŸ
            TimerThread->>TimerMgr: ç»§ç»­ç­‰å¾…
        end
    end
```

---

## ğŸ§© ä¸‰ã€è¯¦ç»†æµç¨‹åˆ†è§£

| æ­¥éª¤            | å†…å®¹                                                                               |
| ------------- | -------------------------------------------------------------------------------- |
| **1. æ³¨å†Œå®šæ—¶å™¨**  | åº”ç”¨è°ƒç”¨æ³¨å†Œæ¥å£ï¼ˆå¦‚ `add_timer(callback, interval)`ï¼‰                                      |
| **2. å­˜å…¥ä»»åŠ¡é˜Ÿåˆ—** | å®šæ—¶å™¨ç®¡ç†å™¨ä¿å­˜ callback å’Œä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´                                                       |
| **3. åå°çº¿ç¨‹è½®è¯¢** | å®šæ—¶å™¨çº¿ç¨‹ä½¿ç”¨ `sleep_until()`ã€`select()`ã€`epoll_wait()` æˆ– `condvar.wait_until()` ç­‰æœºåˆ¶ç­‰å¾… |
| **4. æ£€æŸ¥æ—¶é—´**   | ä¸€æ—¦å½“å‰æ—¶é—´ >= åˆ°æœŸæ—¶é—´ï¼Œå°±è°ƒç”¨å›è°ƒå‡½æ•°                                                           |
| **5. å›è°ƒæ‰§è¡Œ**   | é€šå¸¸åœ¨åå°çº¿ç¨‹ç›´æ¥æ‰§è¡Œå›è°ƒï¼›ä¹Ÿå¯ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—é€šçŸ¥ä¸»çº¿ç¨‹                                                      |
| **6. é‡å¤ä»»åŠ¡**   | å¦‚æœæ˜¯å‘¨æœŸæ€§å®šæ—¶å™¨ï¼Œä¼šé‡è®¾ next\_run æ—¶é—´é‡æ–°åŠ å…¥è½®è¯¢                                                 |

---

## ğŸ§µ å››ã€çº¿ç¨‹é—´å˜é‡å½±å“ç¤ºæ„ï¼ˆå¦‚å›è°ƒè¦ä¿®æ”¹ä¸»çº¿ç¨‹æ•°æ®ï¼‰

```mermaid
sequenceDiagram
    participant MainThread as ä¸»çº¿ç¨‹
    participant TimerThread as å®šæ—¶å™¨çº¿ç¨‹
    participant Callback as å›è°ƒå‡½æ•°

    MainThread->>TimerThread: æ³¨å†Œå®šæ—¶å™¨(callback)
    TimerThread->>Callback: æ‰§è¡Œ callback()
    Callback-->>MainThread: é€šè¿‡é˜Ÿåˆ—/é—­åŒ…/atomic ä¿®æ”¹ä¸»çº¿ç¨‹å˜é‡
```

* âœ… å¦‚æœ**å›è°ƒå‡½æ•°ç›´æ¥ä¿®æ”¹ä¸»çº¿ç¨‹å˜é‡**ï¼Œéœ€è¦ï¼š

  * ä½¿ç”¨ `std::atomic`
  * ä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼ˆä¾‹å¦‚ `std::queue` + mutexï¼‰
  * ä½¿ç”¨ `post()`ã€`dispatch()` ç­‰ä»»åŠ¡åˆ†å‘æœºåˆ¶ï¼ˆå¦‚ Boost.Asioï¼‰

---

## ğŸ§ª ç¤ºä¾‹ï¼šé˜Ÿåˆ—é€šä¿¡æ–¹å¼ï¼ˆä¸»çº¿ç¨‹å˜é‡ç”±å›è°ƒé—´æ¥ä¿®æ”¹ï¼‰

```cpp
std::queue<std::string> messageQueue;
std::mutex queueMutex;

void timerCallback() {
    std::lock_guard<std::mutex> lock(queueMutex);
    messageQueue.push("å®šæ—¶ä»»åŠ¡è§¦å‘");
}

// ä¸»çº¿ç¨‹å¾ªç¯å¤„ç†æ¶ˆæ¯
void processMessages() {
    while (true) {
        std::unique_lock<std::mutex> lock(queueMutex);
        while (!messageQueue.empty()) {
            std::cout << "ä¸»çº¿ç¨‹æ”¶åˆ°ï¼š" << messageQueue.front() << "\n";
            messageQueue.pop();
        }
        lock.unlock();
        std::this_thread::sleep_for(std::chrono::milliseconds(100));
    }
}
```

---

## ğŸ“Œ æ€»ç»“

| ç±»åˆ«      | æè¿°                            |
| ------- | ----------------------------- |
| âœ… æ³¨å†Œ    | åº”ç”¨çº¿ç¨‹è®¾ç½®ä»»åŠ¡ï¼ˆcallback + intervalï¼‰ |
| ğŸ”„ è°ƒåº¦   | å®šæ—¶å™¨çº¿ç¨‹æˆ–äº‹ä»¶å¾ªç¯è½®è¯¢åˆ°æœŸä»»åŠ¡              |
| â±ï¸ è§¦å‘   | åˆ°æœŸåˆ™æ‰§è¡Œ callbackï¼Œæˆ–é€šçŸ¥ä¸»çº¿ç¨‹         |
| ğŸ”§ å…±äº«æ•°æ® | è‹¥å›è°ƒè®¿é—®åŸçº¿ç¨‹æ•°æ®ï¼Œéœ€é€šä¿¡æœºåˆ¶ä¿éšœå®‰å…¨          |

---

å¦‚æœä½ æœ‰ç‰¹å®šå¹³å°ï¼ˆå¦‚ Linux `timerfd`ã€`asio`ã€`libevent`ï¼‰æˆ–ç‰¹å®šé£æ ¼ï¼ˆå¦‚ C å®ç°ã€å•çº¿ç¨‹æ¨¡å‹ï¼‰éœ€è¦è¿›ä¸€æ­¥æ¼”ç¤ºï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥è¡¥å……é‚£éƒ¨åˆ†å†…å®¹ã€‚
